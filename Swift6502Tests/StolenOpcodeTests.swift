func SR(i: UInt8) -> CpuState.StatusRegister {
    return CpuState.StatusRegister(rawValue: i)
}

struct TestState {
    let cpu: CpuState
    let mem: [UInt16:UInt8]
    
    init (_ s : CpuState, _ m : [UInt16:UInt8]) {
        cpu = s
        mem = m
    }
}

struct TestCase {
    let name: String
    let pre:  TestState
    let post: TestState
    
    init (_ n: String, _ pr: TestState, _ po: TestState) {
        name = n
        pre  = pr
        post = po
    }
}

class OpcodeTests : OpcodeTestBase {

    func test_sbc_bcd_on_immediate_9a_minus_00_carry_set() {
        do_the_test(
            TestState(CpuState(A:0x9a, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x39)),
                      [0x0000:0xe9, 0x0001:0x00]),
            TestState(CpuState(A:0x9a, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb9)),
                      [0x0000:0xe9, 0x0001:0x00])
        )
    }

    func test_lda_zp_x_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb5, 0x0001:0x80, 0x007f:0x42]),
            TestState(CpuState(A:0x42, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xb5, 0x0001:0x80, 0x007f:0x42])
        )
    }

    func test_sbc_imm_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xe9, 0x0001:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe9, 0x0001:0x01])
        )
    }

    func test_lda_indexed_ind_y_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb1, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xb1, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_eor_abs_y_indexed_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x59, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x59, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff])
        )
    }

    func test_inc_zp_sets_negative_flag_when_incrementing_above_7F() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe6, 0x0001:0x10, 0x0010:0x7f]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xe6, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_adc_bcd_off_abs_x_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01])
        )
    }

    func test_sec_sets_carry_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x38]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x31)),
                      [0x0000:0x38])
        )
    }

    func test_asl_abs_x_indexed_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb1)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xfe])
        )
    }

    func test_bit_zp_copies_bit_7_of_memory_to_n_flag_when_0() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_bit_zp_copies_bit_7_of_memory_to_n_flag_when_1() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xb0)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_adc_bcd_off_ind_indexed_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x7f, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x71)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff])
        )
    }

    func test_sty_absolute_stores_y_leaves_y_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x8c, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0003, SR:SR(0x7f)),
                      [0x0000:0x8c, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_asl_zp_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb1)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0xfe])
        )
    }

    func test_adc_bcd_off_immediate_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0x01]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x69, 0x0001:0x01])
        )
    }

    func test_lsr_zp_sets_carry_and_zero_flags_after_rotation() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x46, 0x0001:0x10, 0x0010:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x46, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_sbc_ind_x_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x00])
        )
    }

    func test_brk_preserves_decimal_flag_when_it_is_clear() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc000, SR:SR(0x00)),
                      [0xc000:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfc, PC:0x0000, SR:SR(0x14)),
                      [0xc000:0x00, 0x01fe:0x02, 0x01ff:0xc0, 0x01fd:0x30, 0xfffe:0x00, 0xffff:0x00])
        )
    }

    func test_ldx_zp_y_indexed_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb6, 0x0001:0x10, 0x0013:0x80]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xb6, 0x0001:0x10, 0x0013:0x80])
        )
    }

    func test_asl_zp_x_indexed_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_asl_zp_x_indexed_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0x40]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0x80])
        )
    }

    func test_adc_bcd_on_immediate_9c_plus_9d() {
        do_the_test(
            TestState(CpuState(A:0x9c, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x38)),
                      [0x0000:0x69, 0x0001:0x9d, 0x0002:0x69, 0x0003:0x9d]),
            TestState(CpuState(A:0x9f, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x79)),
                      [0x0000:0x69, 0x0001:0x9d, 0x0002:0x69, 0x0003:0x9d])
        )
    }

    func test_iny_increments_y() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x09, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xc8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x0a, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0xc8])
        )
    }

    func test_bne_zero_clear_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x30)),
                      [0x0050:0xd0, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x30)),
                      [0x0050:0xd0, 0x0051:0xff])
        )
    }

    func test_rol_zp_x_indexed_80_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x80]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_lda_zp_x_indexed_page_wraps() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb5, 0x0001:0x80, 0x007f:0x42]),
            TestState(CpuState(A:0x42, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xb5, 0x0001:0x80, 0x007f:0x42])
        )
    }

    func test_and_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x30)),
                      [0x1000:0x31, 0x1001:0xff, 0x0000:0x00, 0x0012:0xff, 0x0100:0x20, 0x2012:0x00, 0x00ff:0x10]),
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0x30)),
                      [0x1000:0x31, 0x1001:0xff, 0x0012:0xff, 0x0000:0x00, 0x2012:0x00, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_asl_abs_x_indexed_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x40]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_rol_accumulator_80_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x33)),
                      [0x0000:0x2a])
        )
    }

    func test_lda_absolute_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xad, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xad, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_lsr_zp_rotates_bits_right() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x46, 0x0001:0x10, 0x0010:0x04]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x46, 0x0001:0x10, 0x0010:0x02])
        )
    }

    func test_sbc_bcd_on_immediate_0a_minus_00_carry_set() {
        do_the_test(
            TestState(CpuState(A:0x0a, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x39)),
                      [0x0000:0xe9, 0x0001:0x00]),
            TestState(CpuState(A:0x0a, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x39)),
                      [0x0000:0xe9, 0x0001:0x00])
        )
    }

    func test_beq_zero_set_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x32)),
                      [0x0050:0xf0, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x32)),
                      [0x0050:0xf0, 0x0051:0xff])
        )
    }

    func test_eor_zp_x_indexed_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x55, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x55, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_adc_bcd_off_zp_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xfe]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xfe])
        )
    }

    func test_rol_zp_x_indexed_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x7f]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0xfe])
        )
    }

    func test_rol_abs_x_indexed_zero_and_carry_one_clears_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x01])
        )
    }

    func test_and_zp_x_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x35, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x35, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_bmi_negative_set_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0xb0)),
                      [0x0050:0x30, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0xb0)),
                      [0x0050:0x30, 0x0051:0xff])
        )
    }

    func test_asl_zp_x_indexed_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb1)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0xfe])
        )
    }

    func test_lsr_accumulator_sets_carry_and_zero_flags_after_rotation() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x4a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x33)),
                      [0x0000:0x4a])
        )
    }

    func test_asl_absolute_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_sta_ind_indexed_x_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x81, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x81, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0xff])
        )
    }

    func test_cld_clears_decimal_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x38)),
                      [0x0000:0xd8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0xd8])
        )
    }

    func test_adc_bcd_off_ind_indexed_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xfe]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xfe])
        )
    }

    func test_ror_accumulator_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6a]),
            TestState(CpuState(A:0x81, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb1)),
                      [0x0000:0x6a])
        )
    }

    func test_ldy_abs_x_indexed_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbc, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x80, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xbc, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_adc_bcd_off_zp_x_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xfe]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xfe])
        )
    }

    func test_ror_zp_zero_and_carry_one_rotates_in_sets_n_flags() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_dec_zp_decrements_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xc6, 0x0001:0x10, 0x0010:0x10]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xc6, 0x0001:0x10, 0x0010:0x0f])
        )
    }

    func test_sta_zp_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x85, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x85, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_rol_absolute_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_tsx_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0x80, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xba]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0x80, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xba])
        )
    }

    func test_and_immediate_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x29, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x29, 0x0001:0x00])
        )
    }

    func test_bpl_negative_clear_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x10, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x30)),
                      [0x0000:0x10, 0x0001:0x06])
        )
    }

    func test_sta_abs_y_indexed_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x99, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xfd)),
                      [0x0000:0x99, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_rol_zp_x_indexed_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb1)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0xfe])
        )
    }

    func test_sed_sets_decimal_mode_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x38)),
                      [0x0000:0xf8])
        )
    }

    func test_iny_sets_negative_flag_when_incrementing_above_7F() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x7f, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xc8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x80, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xc8])
        )
    }

    func test_brk_preserves_decimal_flag_when_it_is_set() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc000, SR:SR(0x08)),
                      [0xc000:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfc, PC:0x0000, SR:SR(0x1c)),
                      [0xc000:0x00, 0x01fe:0x02, 0x01ff:0xc0, 0x01fd:0x38, 0xfffe:0x00, 0xffff:0x00])
        )
    }

    func test_adc_bcd_off_zp_x_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x7f, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x71)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_adc_bcd_off_abs_y_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01])
        )
    }

    func test_adc_bcd_off_absolute_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x00])
        )
    }

    func test_ldx_absolute_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xae, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xae, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_adc_bcd_off_zp_x_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_lda_indexed_ind_y_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb1, 0x0001:0x10, 0xabd0:0x80, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xb1, 0x0001:0x10, 0xabd0:0x80, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_adc_bcd_off_zp_x_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_bit_zp_stores_result_of_and_in_z_preserves_a_when_1() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_txs_transfers_x_into_stack_pointer() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xab, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x9a]),
            TestState(CpuState(A:0x00, X:0xab, Y:0x00, SP:0xab, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x9a])
        )
    }

    func test_txa_transfers_x_into_a() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xab, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x8a]),
            TestState(CpuState(A:0xab, X:0xab, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x8a])
        )
    }

    func test_adc_bcd_off_absolute_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x40]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x40])
        )
    }

    func test_asl_abs_x_indexed_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_and_absolute_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x2d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_inc_zp_x_increments_memory_rolls_over_and_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf6, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xf6, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_ldy_abs_x_indexed_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbc, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xbc, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_ldx_zp_y_indexed_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb6, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xb6, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_inc_zp_x_increments_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf6, 0x0001:0x10, 0x0013:0x09]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xf6, 0x0001:0x10, 0x0013:0x0a])
        )
    }

    func test_adc_bcd_off_abs_y_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01])
        )
    }

    func test_eor_zp_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x45, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x45, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_rol_zp_x_indexed_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_bvs_overflow_set_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x70)),
                      [0x0050:0x70, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x70)),
                      [0x0050:0x70, 0x0051:0xff])
        )
    }

    func test_sbc_zp_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_eor_immediate_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x49, 0x0001:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x49, 0x0001:0xff])
        )
    }

    func test_brk_pushes_pc_plus_2_and_status_then_sets_pc_to_irq_vector() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc000, SR:SR(0x20)),
                      [0xc000:0x00, 0xfffe:0xcd, 0xffff:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfc, PC:0xabcd, SR:SR(0x34)),
                      [0xc000:0x00, 0xfffe:0xcd, 0xffff:0xab, 0x01fd:0x30, 0x01fe:0x02, 0x01ff:0xc0])
        )
    }

    func test_sty_zp_stores_y_leaves_y_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x84, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x84, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_lsr_accumulator_rotates_bits_right() {
        do_the_test(
            TestState(CpuState(A:0x04, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x4a]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x4a])
        )
    }

    func test_ora_absolute_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x82]),
            TestState(CpuState(A:0x83, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x0d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x82])
        )
    }

    func test_jmp_jumps_to_address_with_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6c, 0x0001:0xff, 0x0002:0x00, 0x00ff:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x6c00, SR:SR(0x30)),
                      [0x0000:0x6c, 0x0001:0xff, 0x0002:0x00, 0x00ff:0x00])
        )
    }

    func test_lda_abs_x_indexed_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbd, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xbd, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_ora_zp_x_indexed_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x15, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x15, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_ldy_zp_x_indexed_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb4, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xb4, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_lda_immediate_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa9, 0x0001:0x80]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa9, 0x0001:0x80])
        )
    }

    func test_ora_indexed_ind_y_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x11, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x11, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_asl_absolute_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x40]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80])
        )
    }

    func test_eor_ind_indexed_x_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x41, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x41, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff])
        )
    }

    func test_asl_zp_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0x40]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_lda_absolute_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xad, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xad, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80])
        )
    }

    func test_adc_bcd_off_ind_indexed_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff])
        )
    }

    func test_adc_bcd_off_abs_x_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }

    func test_sbc_zp_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_inc_zp_x_sets_negative_flag_when_incrementing_above_7F() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf6, 0x0001:0x10, 0x0010:0x7f]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xf6, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_rts_wraps_around_top_of_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfd, PC:0x1000, SR:SR(0x30)),
                      [0x1000:0x60, 0x01fe:0xff, 0x01ff:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x1000:0x60, 0x01fe:0xff, 0x01ff:0xff])
        )
    }

    func test_dec_abs_below_00_rolls_over_and_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xce, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xce, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_bit_abs_stores_result_of_and_when_zero_in_z_preserves_a() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_stx_zp_y_indexed_stores_x_leaves_x_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x96, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0xff, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x96, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_adc_bcd_off_indexed_ind_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_sbc_ind_y_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfeed:0x00, 0x0010:0xed, 0x0011:0xfe]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfeed:0x00, 0x0010:0xed, 0x0011:0xfe])
        )
    }

    func test_lsr_accumulator_rotates_in_zero_not_carry() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x4a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x4a])
        )
    }

    func test_dey_decrements_y() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x10, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x88]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x0f, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x88])
        )
    }

    func test_ror_zp_x_indexed_zero_and_carry_one_rotates_in_sets_n_flags() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x80])
        )
    }

    func test_sbc_abs_y_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x0d, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x0d, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_adc_bcd_off_immediate_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0x40]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x69, 0x0001:0x40])
        )
    }

    func test_adc_bcd_off_indexed_ind_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_asl_zp_x_indexed_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0x7f]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x16, 0x0001:0x10, 0x0013:0xfe])
        )
    }

    func test_stx_zp_y_indexed_stores_x_leaves_x_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x96, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x96, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_lsr_zp_x_indexed_sets_carry_and_zero_flags_after_rotation() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x56, 0x0001:0x10, 0x0013:0x01]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x56, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_jmp_abs_jumps_to_absolute_address() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x4c, 0x0001:0xcd, 0x0002:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xabcd, SR:SR(0x30)),
                      [0x0000:0x4c, 0x0001:0xcd, 0x0002:0xab])
        )
    }

    func test_sbc_zp_x_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x00]),
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x00])
        )
    }

    func test_lsr_abs_x_indexed_rotates_in_zero_not_carry() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x5e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x5e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_lsr_zp_rotates_in_zero_not_carry() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x46, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x46, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_plp_pulls_top_byte_from_stack_into_flags_and_updates_sp() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfe, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x28, 0x01ff:0xba]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xba)),
                      [0x0000:0x28, 0x01ff:0xba])
        )
    }

    func test_adc_bcd_off_indexed_ind_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xfe, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xfe, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_bcs_carry_clear_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb0, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xb0, 0x0001:0x06])
        )
    }

    func test_lda_zp_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa5, 0x0001:0x10, 0x0010:0x80]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa5, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_adc_bcd_off_abs_y_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }

    func test_adc_bcd_off_zp_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xff])
        )
    }

    func test_adc_bcd_off_abs_y_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xfe]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xfe])
        )
    }

    func test_lsr_absolute_rotates_bits_right() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x4e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x04]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x4e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x02])
        )
    }

    func test_sbc_abs_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_ldy_zp_loads_y_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa4, 0x0001:0x10, 0x0010:0x80]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x80, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa4, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_ror_zp_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x03]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb1)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x81])
        )
    }

    func test_bvc_overflow_set_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x70)),
                      [0x0000:0x50, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x70)),
                      [0x0000:0x50, 0x0001:0x06])
        )
    }

    func test_eor_absolute_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x4d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x4d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_ror_zp_x_indexed_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_bit_abs_stores_result_of_and_in_z_preserves_a_when_1() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_sbc_ind_y_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfeed:0x01, 0x0010:0xed, 0x0011:0xfe]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfeed:0x01, 0x0010:0xed, 0x0011:0xfe])
        )
    }

    func test_sta_abs_x_indexed_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x9d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x7f)),
                      [0x0000:0x9d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff])
        )
    }

    func test_lda_abs_y_indexed_does_not_page_wrap() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb9, 0x0001:0x80, 0x0002:0x00, 0x017f:0x42]),
            TestState(CpuState(A:0x42, X:0x00, Y:0xff, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0xb9, 0x0001:0x80, 0x0002:0x00, 0x017f:0x42])
        )
    }

    func test_adc_bcd_off_abs_y_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00])
        )
    }

    func test_ror_abs_x_indexed_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x02]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x81])
        )
    }

    func test_rol_zp_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb1)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0xfe])
        )
    }

    func test_jsr_pushes_pc_plus_2_and_sets_pc() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc000, SR:SR(0x30)),
                      [0xc000:0x20, 0xc001:0xd2, 0xc002:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfd, PC:0xffd2, SR:SR(0x30)),
                      [0xc000:0x20, 0xc001:0xd2, 0xc002:0xff, 0x01fe:0x02, 0x01ff:0xc0])
        )
    }

    func test_ldx_abs_y_indexed_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xbe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_adc_bcd_off_abs_x_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01])
        )
    }

    func test_sbc_bcd_on_immediate_20_minus_0a_carry_unset() {
        do_the_test(
            TestState(CpuState(A:0x20, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x38)),
                      [0x0000:0xe9, 0x0001:0x0a]),
            TestState(CpuState(A:0x1f, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x39)),
                      [0x0000:0xe9, 0x0001:0x0a])
        )
    }

    func test_bmi_negative_clear_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x30, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x30, 0x0001:0x06])
        )
    }

    func test_tax_transfers_accumulator_into_x() {
        do_the_test(
            TestState(CpuState(A:0xab, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xaa]),
            TestState(CpuState(A:0xab, X:0xab, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xaa])
        )
    }

    func test_sbc_abs_y_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x0d, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x0d, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_and_ind_indexed_x_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x21, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x21, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00])
        )
    }

    func test_ora_zp_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x05, 0x0001:0x10, 0x0010:0x82]),
            TestState(CpuState(A:0x83, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x05, 0x0001:0x10, 0x0010:0x82])
        )
    }

    func test_and_indexed_ind_y_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x31, 0x0001:0x10, 0xabd0:0xaa, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x31, 0x0001:0x10, 0xabd0:0xaa, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_lda_abs_x_indexed_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbd, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xbd, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_adc_bcd_off_zp_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x01]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x01])
        )
    }

    func test_rol_zp_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x7f]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0xfe])
        )
    }

    func test_inx_increments_x() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x09, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe8]),
            TestState(CpuState(A:0x00, X:0x0a, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0xe8])
        )
    }

    func test_cli_clears_interrupt_mask_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x34)),
                      [0x0000:0x58]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x58])
        )
    }

    func test_adc_bcd_off_abs_x_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x71)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }

    func test_dex_below_00_rolls_over_and_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xca]),
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xca])
        )
    }

    func test_tax_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xaa]),
            TestState(CpuState(A:0x80, X:0x80, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xaa])
        )
    }

    func test_txa_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x8a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x8a])
        )
    }

    func test_adc_bcd_off_zp_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xff]),
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x71)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xff])
        )
    }

    func test_lda_ind_indexed_x_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa1, 0x0001:0x80, 0xbbbb:0xef, 0x0080:0xbb, 0xabcd:0x42, 0x0180:0xab, 0x007f:0xbb, 0x017f:0xcd]),
            TestState(CpuState(A:0xef, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa1, 0x0001:0x80, 0x0080:0xbb, 0xabcd:0x42, 0x0180:0xab, 0x017f:0xcd, 0xbbbb:0xef, 0x007f:0xbb])
        )
    }

    func test_dex_decrements_x() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x10, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xca]),
            TestState(CpuState(A:0x00, X:0x0f, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0xca])
        )
    }

    func test_sbc_ind_x_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x02]),
            TestState(CpuState(A:0x04, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x02])
        )
    }

    func test_asl_accumulator_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0a]),
            TestState(CpuState(A:0xfe, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x0a])
        )
    }

    func test_rol_zp_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x40]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x81])
        )
    }

    func test_adc_bcd_off_absolute_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xfe]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xfe])
        )
    }

    func test_inx_above_FF_rolls_over_and_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0xe8])
        )
    }

    func test_sbc_ind_y_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfef0:0x00, 0x0010:0xed, 0x0011:0xfe]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfef0:0x00, 0x0010:0xed, 0x0011:0xfe])
        )
    }

    func test_adc_bcd_off_absolute_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x71)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }

    func test_adc_bcd_off_ind_indexed_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x01]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x01])
        )
    }

    func test_lda_zp_x_indexed_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb5, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xb5, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_dec_zp_sets_zero_flag_when_decrementing_to_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xc6, 0x0001:0x10, 0x0010:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xc6, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_ror_zp_x_indexed_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x03]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb1)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x81])
        )
    }

    func test_and_zp_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x25, 0x0001:0x10, 0x0010:0xaa]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x25, 0x0001:0x10, 0x0010:0xaa])
        )
    }

    func test_adc_bcd_off_zp_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x00])
        )
    }

    func test_and_absolute_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xaa]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x2d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xaa])
        )
    }

    func test_asl_accumulator_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0a]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x0a])
        )
    }

    func test_adc_bcd_off_immediate_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0x01]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0x01])
        )
    }

    func test_sta_zp_x_indexed_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x95, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x95, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_rol_absolute_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x7f]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xfe])
        )
    }

    func test_adc_bcd_off_immediate_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x69, 0x0001:0x00])
        )
    }

    func test_adc_bcd_off_indexed_ind_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x7f, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x71)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_adc_bcd_off_zp_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x01]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x01])
        )
    }

    func test_bvs_overflow_set_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x70)),
                      [0x0000:0x70, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x70)),
                      [0x0000:0x70, 0x0001:0x06])
        )
    }

    func test_adc_bcd_off_immediate_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x69, 0x0001:0xff])
        )
    }

    func test_rol_absolute_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb1)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xfe])
        )
    }

    func test_adc_bcd_off_ind_indexed_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00])
        )
    }

    func test_adc_bcd_off_ind_indexed_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00])
        )
    }

    func test_stx_zp_stores_x_leaves_x_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x86, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x86, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_sbc_abs_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_eor_abs_y_indexed_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x59, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x59, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff])
        )
    }

    func test_asl_zp_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0x7f]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0xfe])
        )
    }

    func test_sbc_ind_y_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfeed:0x02, 0x0010:0xed, 0x0011:0xfe]),
            TestState(CpuState(A:0x04, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0xf1, 0x0001:0x10, 0xfeed:0x02, 0x0010:0xed, 0x0011:0xfe])
        )
    }

    func test_rol_abs_x_indexed_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_inc_abs_x_sets_negative_flag_when_incrementing_above_7F() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xfe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x7f]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xfe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_adc_bcd_off_zp_x_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x01]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x01])
        )
    }

    func test_adc_bcd_off_absolute_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01])
        )
    }

    func test_eor_immediate_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x49, 0x0001:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x49, 0x0001:0xff])
        )
    }

    func test_sei_sets_interrupt_disable_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x78]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x34)),
                      [0x0000:0x78])
        )
    }

    func test_bcc_carry_set_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x90, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0x90, 0x0001:0x06])
        )
    }

    func test_ldy_zp_loads_y_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa4, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa4, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_sta_indexed_ind_y_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x91, 0x0001:0x10, 0xfef0:0x00, 0x0010:0xed, 0x0011:0xfe]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x91, 0x0001:0x10, 0xfef0:0xff, 0x0010:0xed, 0x0011:0xfe])
        )
    }

    func test_sta_indexed_ind_y_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x91, 0x0001:0x10, 0xfef0:0xff, 0x0010:0xed, 0x0011:0xfe]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x91, 0x0001:0x10, 0xfef0:0x00, 0x0010:0xed, 0x0011:0xfe])
        )
    }

    func test_lsr_abs_x_indexed_rotates_bits_right() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x5e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x04]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x5e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x02])
        )
    }

    func test_dec_abs_decrements_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xce, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x10]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0xce, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x0f])
        )
    }

    func test_txs_does_not_set_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x9a]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0x80, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x9a])
        )
    }

    func test_rti_restores_status_and_pc_and_updates_sp() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfc, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x40, 0x01fd:0xfc, 0x01fe:0x03, 0x01ff:0xc0]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc003, SR:SR(0xfc)),
                      [0x0000:0x40, 0x01fd:0xfc, 0x01fe:0x03, 0x01ff:0xc0])
        )
    }

    func test_adc_bcd_off_ind_indexed_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x01]),
            TestState(CpuState(A:0x02, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x01])
        )
    }

    func test_dex_sets_zero_flag_when_decrementing_to_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x01, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xca]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0xca])
        )
    }

    func test_and_abs_x_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x3d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xaa]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x3d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xaa])
        )
    }

    func test_ora_abs_y_indexed_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x19, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x82]),
            TestState(CpuState(A:0x83, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x19, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x82])
        )
    }

    func test_rol_zp_zero_and_carry_one_clears_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x01])
        )
    }

    func test_adc_bcd_off_zp_x_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x40]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x40])
        )
    }

    func test_bit_abs_copies_bit_6_of_memory_to_v_flag_when_0() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0xff])
        )
    }

    func test_tya_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x80, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x98]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x80, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x98])
        )
    }

    func test_adc_bcd_off_abs_x_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x40]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x40])
        )
    }

    func test_ror_absolute_zero_and_carry_one_rotates_in_sets_n_flags() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80])
        )
    }

    func test_lda_ind_indexed_x_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa1, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa1, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00])
        )
    }

    func test_sbc_abs_y_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x0d, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x0d, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x01])
        )
    }

    func test_ror_abs_x_indexed_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_bpl_negative_clear_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x30)),
                      [0x0050:0x10, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x30)),
                      [0x0050:0x10, 0x0051:0xff])
        )
    }

    func test_bit_zp_stores_result_of_and_when_zero_in_z_preserves_a() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_sty_zp_x_indexed_stores_y_leaves_y_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x94, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0xff, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x94, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_asl_abs_x_indexed_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x7f]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x1e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xfe])
        )
    }

    func test_lda_abs_x_indexed_does_not_page_wrap() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbd, 0x0001:0x80, 0x0002:0x00, 0x017f:0x42]),
            TestState(CpuState(A:0x42, X:0xff, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0xbd, 0x0001:0x80, 0x0002:0x00, 0x017f:0x42])
        )
    }

    func test_stx_absolute_stores_x_leaves_x_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x8e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xfd)),
                      [0x0000:0x8e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_dec_abs_x_decrements_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xde, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x10]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0xde, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x0f])
        )
    }

    func test_adc_bcd_off_zp_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x00])
        )
    }

    func test_bcc_carry_clear_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x90, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x30)),
                      [0x0000:0x90, 0x0001:0x06])
        )
    }

    func test_sbc_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x01)),
                      [0x1000:0xf1, 0x1001:0xff, 0x0000:0x00, 0x0012:0x03, 0x0100:0x20, 0x2012:0x02, 0x00ff:0x10]),
            TestState(CpuState(A:0x3f, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0x01)),
                      [0x1000:0xf1, 0x1001:0xff, 0x0012:0x03, 0x0000:0x00, 0x2012:0x02, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_dec_zp_below_00_rolls_over_and_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xc6, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xc6, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_inc_abs_x_increments_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xfe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x09]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0xfe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x0a])
        )
    }

    func test_sta_zp_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x85, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x85, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_lsr_zp_x_indexed_rotates_bits_right() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x56, 0x0001:0x10, 0x0013:0x04]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x56, 0x0001:0x10, 0x0013:0x02])
        )
    }

    func test_sta_abs_y_indexed_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x99, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x7f)),
                      [0x0000:0x99, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff])
        )
    }

    func test_sty_zp_x_indexed_stores_y_leaves_y_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x94, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x94, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_adc_bcd_off_immediate_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0xff]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0x69, 0x0001:0xff])
        )
    }

    func test_ror_accumulator_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x6a])
        )
    }

    func test_lsr_abs_x_indexed_sets_c_and_z_flags_after_rotation() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x5e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x01]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x5e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_lda_abs_y_indexed_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb9, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xb9, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_sbc_abs_x_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x01]),
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x01])
        )
    }

    func test_sta_abs_x_indexed_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x9d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xfd)),
                      [0x0000:0x9d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_and_indexed_ind_y_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x31, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x31, 0x0001:0x10, 0xabd0:0x00, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_asl_accumulator_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x0a])
        )
    }

    func test_bmi_negative_set_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xb0)),
                      [0x0000:0x30, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0xb0)),
                      [0x0000:0x30, 0x0001:0x06])
        )
    }

    func test_beq_zero_set_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x32)),
                      [0x0000:0xf0, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x32)),
                      [0x0000:0xf0, 0x0001:0x06])
        )
    }

    func test_ror_absolute_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_bit_zp_copies_bit_6_of_memory_to_v_flag_when_1() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x70)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_bit_zp_copies_bit_6_of_memory_to_v_flag_when_0() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_rti_forces_break_and_unused_flags_high() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfc, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x40, 0x01fd:0x00, 0x01fe:0x03, 0x01ff:0xc0]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc003, SR:SR(0x30)),
                      [0x0000:0x40, 0x01fd:0x00, 0x01fe:0x03, 0x01ff:0xc0])
        )
    }

    func test_sta_absolute_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x8d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xfd)),
                      [0x0000:0x8d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_ror_absolute_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x03]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb1)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x81])
        )
    }

    func test_ora_abs_x_indexed_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x1d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x82]),
            TestState(CpuState(A:0x83, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x1d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x82])
        )
    }

    func test_adc_bcd_on_immediate_6f_plus_00_carry_set() {
        do_the_test(
            TestState(CpuState(A:0x6f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x39)),
                      [0x0000:0x69, 0x0001:0x00]),
            TestState(CpuState(A:0x76, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x38)),
                      [0x0000:0x69, 0x0001:0x00])
        )
    }

    func test_ldx_immediate_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa2, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa2, 0x0001:0x00])
        )
    }

    func test_ror_abs_x_indexed_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x03]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb1)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x81])
        )
    }

    func test_ror_zp_x_indexed_zero_absolute_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x02]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x76, 0x0001:0x10, 0x0013:0x81])
        )
    }

    func test_asl_absolute_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x7f]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xfe])
        )
    }

    func test_adc_ind_indexed_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x00)),
                      [0x0000:0x61, 0x0001:0x80, 0xbbbb:0x02, 0x0080:0xbb, 0xabcd:0x01, 0x0180:0xab, 0x007f:0xbb, 0x017f:0xcd]),
            TestState(CpuState(A:0x03, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x00)),
                      [0x0000:0x61, 0x0001:0x80, 0x0080:0xbb, 0xabcd:0x01, 0x0180:0xab, 0x017f:0xcd, 0xbbbb:0x02, 0x007f:0xbb])
        )
    }

    func test_eor_abs_x_indexed_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x5d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x5d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff])
        )
    }

    func test_nop_does_nothing() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xea]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0xea])
        )
    }

    func test_sbc_imm_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe9, 0x0001:0x02]),
            TestState(CpuState(A:0x04, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0xe9, 0x0001:0x02])
        )
    }

    func test_sta_ind_indexed_x_stores_a_leaves_a_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x81, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x81, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x00])
        )
    }

    func test_inc_abs_sets_negative_flag_when_incrementing_above_7F() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xee, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x7f]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xee, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80])
        )
    }

    func test_tax_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xaa]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0xaa])
        )
    }

    func test_brk_interrupt() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x00)),
                      [0x0000:0xa9, 0x0001:0x01, 0x0002:0x00, 0x0003:0xea, 0x0004:0xea, 0x0005:0xea, 0x0006:0xa9, 0x0007:0x03, 0x0402:0x40, 0x0401:0x02, 0x0400:0xa9, 0xfffe:0x00, 0xffff:0x04]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x00)),
                      [0x0000:0xa9, 0x0001:0x01, 0x0002:0x00, 0x0003:0xea, 0x0004:0xea, 0x0005:0xea, 0x0006:0xa9, 0x0007:0x03, 0x0402:0x40, 0x0401:0x02, 0xffff:0x04, 0xfffe:0x00, 0x0400:0xa9])
        )
    }

    func test_inc_abs_increments_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xee, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x09]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0xee, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x0a])
        )
    }

    func test_adc_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x00)),
                      [0x1000:0x71, 0x1001:0xff, 0x0000:0x00, 0x0012:0x42, 0x0100:0x20, 0x2012:0x14, 0x00ff:0x10]),
            TestState(CpuState(A:0x84, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0xc0)),
                      [0x1000:0x71, 0x1001:0xff, 0x0012:0x42, 0x0000:0x00, 0x2012:0x14, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_adc_bcd_off_ind_indexed_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff])
        )
    }

    func test_bne_zero_set_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x32)),
                      [0x0000:0xd0, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xd0, 0x0001:0x06])
        )
    }

    func test_bit_abs_copies_bit_6_of_memory_to_v_flag_when_1() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x70)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_sbc_abs_x_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x02]),
            TestState(CpuState(A:0x04, X:0x0d, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x31)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x02])
        )
    }

    func test_ora_ind_indexed_x_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x01, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x82]),
            TestState(CpuState(A:0x83, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x01, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x82])
        )
    }

    func test_cmp_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x00)),
                      [0x1000:0xd1, 0x1001:0xff, 0x0000:0x00, 0x0012:0x42, 0x0100:0x20, 0x2012:0x14, 0x00ff:0x10]),
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0x03)),
                      [0x1000:0xd1, 0x1001:0xff, 0x0012:0x42, 0x0000:0x00, 0x2012:0x14, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_ror_accumulator_zero_and_carry_one_rotates_in_sets_n_flags() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6a]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x6a])
        )
    }

    func test_tsx_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0x00, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xba]),
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0x00, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0xba])
        )
    }

    func test_adc_bcd_off_abs_x_carry_clear_in_accumulator_zeroes() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00])
        )
    }

    func test_rol_abs_x_indexed_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x7f]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xfe])
        )
    }

    func test_tay_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa8]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x80, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xa8])
        )
    }

    func test_ora_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x30)),
                      [0x1000:0x11, 0x1001:0xff, 0x0000:0x00, 0x0012:0x42, 0x0100:0x20, 0x2012:0x00, 0x00ff:0x10]),
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0x30)),
                      [0x1000:0x11, 0x1001:0xff, 0x0012:0x42, 0x0000:0x00, 0x2012:0x00, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_sbc_abs_x_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_dey_below_00_rolls_over_and_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x88]),
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x88])
        )
    }

    func test_tsx_transfers_stack_pointer_into_x() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xab, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xba]),
            TestState(CpuState(A:0x00, X:0xab, Y:0x00, SP:0xab, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xba])
        )
    }

    func test_ora_abs_y_indexed_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x19, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x19, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_sbc_ind_x_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x00])
        )
    }

    func test_sty_absolute_stores_y_leaves_y_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x8c, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xfd)),
                      [0x0000:0x8c, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_bpl_negative_set_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xb0)),
                      [0x0000:0x10, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x10, 0x0001:0x06])
        )
    }

    func test_rol_absolute_80_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_ldy_immediate_loads_y_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa0, 0x0001:0x80]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x80, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa0, 0x0001:0x80])
        )
    }

    func test_ror_accumulator_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6a]),
            TestState(CpuState(A:0x81, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x6a])
        )
    }

    func test_jmp_ind_jumps_to_indirect_address() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6c, 0x0001:0x00, 0x0002:0x02, 0x0200:0xcd, 0x0201:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xabcd, SR:SR(0x30)),
                      [0x0000:0x6c, 0x0001:0x00, 0x0002:0x02, 0x0200:0xcd, 0x0201:0xab])
        )
    }

    func test_clv_clears_overflow_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x70)),
                      [0x0000:0xb8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0xb8])
        )
    }

    func test_bvs_overflow_clear_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x70, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x70, 0x0001:0x06])
        )
    }

    func test_adc_bcd_on_immediate_79_plus_00_carry_set() {
        do_the_test(
            TestState(CpuState(A:0x79, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x39)),
                      [0x0000:0x69, 0x0001:0x00]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf8)),
                      [0x0000:0x69, 0x0001:0x00])
        )
    }

    func test_inx_sets_negative_flag_when_incrementing_above_7F() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x7f, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe8]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xe8])
        )
    }

    func test_rol_accumulator_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x2a]),
            TestState(CpuState(A:0x81, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x2a])
        )
    }

    func test_ora_absolute_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x0d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_bcc_carry_clear_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x30)),
                      [0x0050:0x90, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x30)),
                      [0x0050:0x90, 0x0051:0xff])
        )
    }

    func test_adc_bcd_off_absolute_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }

    func test_eor_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x30)),
                      [0x1000:0x51, 0x1001:0xff, 0x0000:0x00, 0x0012:0xff, 0x0100:0x20, 0x2012:0x00, 0x00ff:0x10]),
            TestState(CpuState(A:0x55, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0x30)),
                      [0x1000:0x51, 0x1001:0xff, 0x0012:0xff, 0x0000:0x00, 0x2012:0x00, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_ora_zp_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x05, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x05, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_php_pushes_processor_status_and_updates_sp() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x08]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfe, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x08, 0x01ff:0x30])
        )
    }

    func test_adc_bcd_off_indexed_ind_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_bvc_overflow_clear_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x50, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x30)),
                      [0x0000:0x50, 0x0001:0x06])
        )
    }

    func test_tay_transfers_accumulator_into_y() {
        do_the_test(
            TestState(CpuState(A:0xab, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa8]),
            TestState(CpuState(A:0xab, X:0x00, Y:0xab, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0xa8])
        )
    }

    func test_and_zp_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x25, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x25, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_adc_bcd_off_ind_indexed_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x40]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x61, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x40])
        )
    }

    func test_asl_accumulator_80_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x33)),
                      [0x0000:0x0a])
        )
    }

    func test_ldx_zp_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa6, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa6, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_bvc_overflow_clear_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x30)),
                      [0x0050:0x50, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x30)),
                      [0x0050:0x50, 0x0051:0xff])
        )
    }

    func test_sbc_abs_y_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x00, Y:0x0d, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x02]),
            TestState(CpuState(A:0x04, X:0x00, Y:0x0d, SP:0xff, PC:0x0003, SR:SR(0x31)),
                      [0x0000:0xf9, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x02])
        )
    }

    func test_adc_bcd_off_abs_y_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xff]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x31)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xff])
        )
    }

    func test_dec_zp_x_sets_zero_flag_when_decrementing_to_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xd6, 0x0001:0x10, 0x0013:0x01]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xd6, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_bit_zp_stores_result_of_and_when_nonzero_in_z_preserves_a() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x32)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x01]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x24, 0x0001:0x10, 0x0010:0x01])
        )
    }

    func test_inc_zp_increments_memory_rolls_over_and_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe6, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xe6, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_rol_abs_x_indexed_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb1)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xfe])
        )
    }

    func test_ldx_absolute_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xae, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xae, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80])
        )
    }

    func test_cmp_ind_x_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x42, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x00)),
                      [0x0000:0xc1, 0x0001:0x80, 0xbbbb:0x42, 0x0080:0xbb, 0xabcd:0x00, 0x0180:0xab, 0x007f:0xbb, 0x017f:0xcd]),
            TestState(CpuState(A:0x42, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x03)),
                      [0x0000:0xc1, 0x0001:0x80, 0x0080:0xbb, 0xabcd:0x00, 0x0180:0xab, 0x017f:0xcd, 0xbbbb:0x42, 0x007f:0xbb])
        )
    }

    func test_sbc_zp_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x02]),
            TestState(CpuState(A:0x04, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x02])
        )
    }

    func test_adc_bcd_off_zp_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x40]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0x40])
        )
    }

    func test_clc_clears_carry_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x18]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x18])
        )
    }

    func test_sbc_imm_downto_zero_with_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe9, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe9, 0x0001:0x00])
        )
    }

    func test_ror_zp_zero_absolute_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x02]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x81])
        )
    }

    func test_eor_ind_indexed_x_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x41, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x41, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xff])
        )
    }

    func test_sbc_zp_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe5, 0x0001:0x10, 0x0010:0x01])
        )
    }

    func test_rol_abs_x_indexed_80_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_ldx_zp_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa6, 0x0001:0x10, 0x0010:0x80]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa6, 0x0001:0x10, 0x0010:0x80])
        )
    }

    func test_adc_bcd_off_abs_x_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00]),
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00])
        )
    }

    func test_adc_bcd_off_zp_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xff]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0x65, 0x0001:0xb0, 0x00b0:0xff])
        )
    }

    func test_sta_zp_x_indexed_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x95, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x95, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_dec_abs_sets_zero_flag_when_decrementing_to_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xce, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xce, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_lda_zp_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa5, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa5, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_rol_zp_x_indexed_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x40]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x81])
        )
    }

    func test_lda_indexed_ind_y_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x02, SP:0xff, PC:0x1000, SR:SR(0x30)),
                      [0x1000:0xb1, 0x1001:0xff, 0x0000:0x00, 0x0012:0x42, 0x0100:0x20, 0x2012:0x14, 0x00ff:0x10]),
            TestState(CpuState(A:0x42, X:0x00, Y:0x02, SP:0xff, PC:0x1002, SR:SR(0x30)),
                      [0x1000:0xb1, 0x1001:0xff, 0x0012:0x42, 0x0000:0x00, 0x2012:0x14, 0x0100:0x20, 0x00ff:0x10])
        )
    }

    func test_ldx_immediate_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa2, 0x0001:0x80]),
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa2, 0x0001:0x80])
        )
    }

    func test_dec_zp_x_decrements_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xd6, 0x0001:0x10, 0x0013:0x10]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xd6, 0x0001:0x10, 0x0013:0x0f])
        )
    }

    func test_and_abs_y_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x39, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x39, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_ror_zp_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x66, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_rol_accumulator_zero_and_carry_one_clears_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x2a]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x2a])
        )
    }

    func test_ldy_immediate_loads_y_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa0, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa0, 0x0001:0x00])
        )
    }

    func test_tya_transfers_y_into_a() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xab, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x98]),
            TestState(CpuState(A:0xab, X:0x00, Y:0xab, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x98])
        )
    }

    func test_rol_absolute_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x40]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x81])
        )
    }

    func test_bit_abs_copies_bit_7_of_memory_to_n_flag_when_1() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xb0)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_bit_abs_copies_bit_7_of_memory_to_n_flag_when_0() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0xff]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0xff])
        )
    }

    func test_lda_ind_indexed_x_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa1, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x80]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xa1, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x80])
        )
    }

    func test_ldx_abs_y_indexed_loads_x_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xbe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xbe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_ror_absolute_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x02]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x6e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x81])
        )
    }

    func test_rol_accumulator_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x2a])
        )
    }

    func test_and_immediate_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x29, 0x0001:0xaa]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x29, 0x0001:0xaa])
        )
    }

    func test_dey_sets_zero_flag_when_decrementing_to_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x01, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x88]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x88])
        )
    }

    func test_lda_immediate_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa9, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0xa9, 0x0001:0x00])
        )
    }

    func test_bcs_carry_set_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xb0, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x31)),
                      [0x0000:0xb0, 0x0001:0x06])
        )
    }

    func test_ora_indexed_ind_y_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x11, 0x0001:0x10, 0xabd0:0x82, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x83, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x11, 0x0001:0x10, 0xabd0:0x82, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_bne_zero_clear_branches_relative_forward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xd0, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0008, SR:SR(0x30)),
                      [0x0000:0xd0, 0x0001:0x06])
        )
    }

    func test_rol_zp_zero_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_ora_immediate_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x09, 0x0001:0x82]),
            TestState(CpuState(A:0x83, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x09, 0x0001:0x82])
        )
    }

    func test_txs_does_not_set_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x9a]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0x00, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x9a])
        )
    }

    func test_adc_bcd_off_zp_x_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_sbc_zp_x_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x01]),
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x01])
        )
    }

    func test_lsr_absolute_rotates_in_zero_not_carry() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x4e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x4e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_sbc_abs_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x02]),
            TestState(CpuState(A:0x04, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x31)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x02])
        )
    }

    func test_inc_abs_x_increments_memory_rolls_over_and_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xfe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xfe, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_adc_bcd_off_indexed_ind_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x01, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x01, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_adc_bcd_off_indexed_ind_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x40, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x40, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_inc_abs_increments_memory_rolls_over_and_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xee, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xee, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_sbc_imm_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xe9, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe9, 0x0001:0x00])
        )
    }

    func test_rol_zp_80_and_carry_zero_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x80]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x26, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_dec_zp_x_below_00_rolls_over_and_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xd6, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xd6, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_ora_abs_x_indexed_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x1d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x1d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_lda_abs_y_indexed_loads_a_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb9, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xb9, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_ora_immediate_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x09, 0x0001:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x09, 0x0001:0x00])
        )
    }

    func test_pha_pushes_a_and_updates_sp() {
        do_the_test(
            TestState(CpuState(A:0xab, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x48]),
            TestState(CpuState(A:0xab, X:0x00, Y:0x00, SP:0xfe, PC:0x0001, SR:SR(0x30)),
                      [0x0000:0x48, 0x01ff:0xab])
        )
    }

    func test_ldy_absolute_loads_y_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xac, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xac, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_adc_bcd_off_zp_x_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_pla_pulls_top_byte_from_stack_into_a_and_updates_sp() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfe, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x68, 0x01ff:0xab]),
            TestState(CpuState(A:0xab, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x68, 0x01ff:0xab])
        )
    }

    func test_inc_zp_increments_memory() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xe6, 0x0001:0x10, 0x0010:0x09]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xe6, 0x0001:0x10, 0x0010:0x0a])
        )
    }

    func test_rol_abs_x_indexed_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x40]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x3e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x81])
        )
    }

    func test_rol_accumulator_shifts_out_zero() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2a]),
            TestState(CpuState(A:0xfe, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x2a])
        )
    }

    func test_adc_bcd_off_absolute_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01]),
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0x01])
        )
    }

    func test_sbc_zp_x_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x00]),
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x00])
        )
    }

    func test_adc_bcd_off_abs_x_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xfe]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xfe])
        )
    }

    func test_adc_bcd_off_abs_x_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xff]),
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x31)),
                      [0x0000:0x7d, 0x0001:0x00, 0x0002:0xc0, 0xc003:0xff])
        )
    }

    func test_eor_ind_x_has_page_wrap_bug() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x00)),
                      [0x0000:0x41, 0x0001:0x80, 0xbbbb:0xff, 0x0080:0xbb, 0xabcd:0x00, 0x0180:0xab, 0x007f:0xbb, 0x017f:0xcd]),
            TestState(CpuState(A:0x55, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x00)),
                      [0x0000:0x41, 0x0001:0x80, 0x0080:0xbb, 0xabcd:0x00, 0x0180:0xab, 0x017f:0xcd, 0xbbbb:0xff, 0x007f:0xbb])
        )
    }

    func test_adc_bcd_off_zp_x_overflow_clr_no_carry_01_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x01]),
            TestState(CpuState(A:0x02, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x75, 0x0001:0x10, 0x0013:0x01])
        )
    }

    func test_eor_abs_x_indexed_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x5d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x5d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xff])
        )
    }

    func test_dec_abs_x_below_00_rolls_over_and_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xde, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xde, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_asl_absolute_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb1)),
                      [0x0000:0x0e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xfe])
        )
    }

    func test_sbc_bcd_on_immediate_00_minus_01_carry_set() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7b)),
                      [0x0000:0xe9, 0x0001:0x01]),
            TestState(CpuState(A:0x99, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb8)),
                      [0x0000:0xe9, 0x0001:0x01])
        )
    }

    func test_tay_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xa8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0xa8])
        )
    }

    func test_eor_zp_x_indexed_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x55, 0x0001:0x10, 0x0013:0xff]),
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x55, 0x0001:0x10, 0x0013:0xff])
        )
    }

    func test_sbc_abs_x_all_zeros_and_no_borrow_is_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00]),
            TestState(CpuState(A:0x00, X:0x0d, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xfd, 0x0001:0xe0, 0x0002:0xfe, 0xfeed:0x00])
        )
    }

    func test_stx_absolute_stores_x_leaves_x_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x8e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x7f)),
                      [0x0000:0x8e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_adc_bcd_off_abs_y_overflow_set_on_40_plus_40() {
        do_the_test(
            TestState(CpuState(A:0x40, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x40]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xf0)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x40])
        )
    }

    func test_sbc_zp_x_downto_four_with_borrow_clears_z_n() {
        do_the_test(
            TestState(CpuState(A:0x07, X:0x0d, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x02]),
            TestState(CpuState(A:0x04, X:0x0d, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x31)),
                      [0x0000:0xf5, 0x0001:0x10, 0x001d:0x02])
        )
    }

    func test_ldy_zp_x_indexed_loads_x_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb4, 0x0001:0x10, 0x0013:0x80]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x80, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xb4, 0x0001:0x10, 0x0013:0x80])
        )
    }

    func test_txa_sets_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x80, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x8a]),
            TestState(CpuState(A:0x80, X:0x80, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb0)),
                      [0x0000:0x8a])
        )
    }

    func test_stx_zp_stores_x_leaves_x_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x86, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0xff, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x7f)),
                      [0x0000:0x86, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_eor_zp_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x45, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x45, 0x0001:0x10, 0x0010:0xff])
        )
    }

    func test_sbc_abs_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0xed, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x01])
        )
    }

    func test_lsr_absolute_sets_carry_and_zero_flags_after_rotation() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x4e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x33)),
                      [0x0000:0x4e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_sta_absolute_stores_a_leaves_a_and_n_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x7f)),
                      [0x0000:0x8d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x7f)),
                      [0x0000:0x8d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_beq_zero_clear_does_not_branch() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xf0, 0x0001:0x06]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0xf0, 0x0001:0x06])
        )
    }

    func test_eor_indexed_ind_y_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x51, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x51, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_adc_bcd_off_abs_y_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc003:0x00])
        )
    }

    func test_lsr_zp_x_indexed_rotates_in_zero_not_carry() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x56, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x56, 0x0001:0x10, 0x0013:0x00])
        )
    }

    func test_bcs_carry_set_branches_relative_backward() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0050, SR:SR(0x31)),
                      [0x0050:0xb0, 0x0051:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0051, SR:SR(0x31)),
                      [0x0050:0xb0, 0x0051:0xff])
        )
    }

    func test_adc_bcd_off_immediate_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0xff]),
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x71)),
                      [0x0000:0x69, 0x0001:0xff])
        )
    }

    func test_tya_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x98]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0x98])
        )
    }

    func test_rol_absolute_zero_and_carry_one_clears_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x2e, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x01])
        )
    }

    func test_bit_abs_stores_result_of_and_when_nonzero_in_z_preserves_a() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x32)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x01]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x30)),
                      [0x0000:0x2c, 0x0001:0xed, 0x0002:0xfe, 0xfeed:0x01])
        )
    }

    func test_and_ind_indexed_x_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x21, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xaa]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x21, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0xaa])
        )
    }

    func test_and_abs_x_all_zeros_setting_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x3d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x3d, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00])
        )
    }

    func test_adc_bcd_off_indexed_ind_overflow_set_no_carry_7f_plus_01() {
        do_the_test(
            TestState(CpuState(A:0x7f, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x01, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x80, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xf0)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0x01, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_ora_zp_x_indexed_turns_bits_on_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x03, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x15, 0x0001:0x10, 0x0013:0x82]),
            TestState(CpuState(A:0x83, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x15, 0x0001:0x10, 0x0013:0x82])
        )
    }

    func test_rol_zp_x_indexed_zero_and_carry_one_clears_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x36, 0x0001:0x10, 0x0013:0x01])
        )
    }

    func test_adc_bcd_off_immediate_carry_set_in_accumulator_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x69, 0x0001:0x00]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0x00])
        )
    }

    func test_ldy_absolute_loads_y_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xac, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x80, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0xac, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x80])
        )
    }

    func test_dec_abs_x_sets_zero_flag_when_decrementing_to_zero() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xde, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x01]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0xde, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0x00])
        )
    }

    func test_ora_ind_indexed_x_zeroes_or_zeros_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x01, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x01, 0x0001:0x10, 0x0013:0xcd, 0x0014:0xab, 0xabcd:0x00])
        )
    }

    func test_and_zp_x_all_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x35, 0x0001:0x10, 0x0013:0xaa]),
            TestState(CpuState(A:0xaa, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x35, 0x0001:0x10, 0x0013:0xaa])
        )
    }

    func test_adc_bcd_off_immediate_carry_clear_in_no_carry_clear_out() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x69, 0x0001:0xfe]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x69, 0x0001:0xfe])
        )
    }

    func test_sbc_ind_x_downto_zero_no_borrow_sets_z_clears_n() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x01]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0xe1, 0x0001:0x10, 0x0013:0xed, 0x0014:0xfe, 0xfeed:0x01])
        )
    }

    func test_adc_bcd_off_indexed_ind_overflow_clr_no_carry_01_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x01, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0x33)),
                      [0x0000:0x71, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_rol_accumulator_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x2a]),
            TestState(CpuState(A:0xfe, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb1)),
                      [0x0000:0x2a])
        )
    }

    func test_adc_bcd_off_absolute_carry_clear_in_carry_set_out() {
        do_the_test(
            TestState(CpuState(A:0x02, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x01, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x31)),
                      [0x0000:0x6d, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }

    func test_sty_zp_stores_y_leaves_y_and_z_flag_unchanged() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0xfd)),
                      [0x0000:0x84, 0x0001:0x10, 0x0010:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xfd)),
                      [0x0000:0x84, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_eor_absolute_flips_bits_over_setting_z_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x4d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x32)),
                      [0x0000:0x4d, 0x0001:0xcd, 0x0002:0xab, 0xabcd:0xff])
        )
    }

    func test_eor_indexed_ind_y_flips_bits_over_setting_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x51, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab]),
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0x51, 0x0001:0x10, 0xabd0:0xff, 0x0010:0xcd, 0x0011:0xab])
        )
    }

    func test_asl_zp_sets_z_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0x00]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0x32)),
                      [0x0000:0x06, 0x0001:0x10, 0x0010:0x00])
        )
    }

    func test_and_abs_y_zeros_and_ones_setting_negative_flag() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x03, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x39, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xaa]),
            TestState(CpuState(A:0xaa, X:0x00, Y:0x03, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x39, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0xaa])
        )
    }

    func test_lda_zp_x_indexed_loads_a_sets_n_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xb5, 0x0001:0x10, 0x0013:0x80]),
            TestState(CpuState(A:0x80, X:0x03, Y:0x00, SP:0xff, PC:0x0002, SR:SR(0xb0)),
                      [0x0000:0xb5, 0x0001:0x10, 0x0013:0x80])
        )
    }

    func test_rts_restores_pc_and_increments_then_updates_sp() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xfd, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x60, 0x01fe:0x03, 0x01ff:0xc0]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0xc004, SR:SR(0x30)),
                      [0x0000:0x60, 0x01fe:0x03, 0x01ff:0xc0])
        )
    }

    func test_ror_abs_x_indexed_z_and_c_1_rotates_in_sets_n_flags() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x31)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x00]),
            TestState(CpuState(A:0x00, X:0x03, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0xb0)),
                      [0x0000:0x7e, 0x0001:0xcd, 0x0002:0xab, 0xabd0:0x80])
        )
    }

    func test_iny_above_FF_rolls_over_and_sets_zero_flag() {
        do_the_test(
            TestState(CpuState(A:0x00, X:0x00, Y:0xff, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0xc8]),
            TestState(CpuState(A:0x00, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0x32)),
                      [0x0000:0xc8])
        )
    }

    func test_asl_accumulator_shifts_out_one() {
        do_the_test(
            TestState(CpuState(A:0xff, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x0a]),
            TestState(CpuState(A:0xfe, X:0x00, Y:0x00, SP:0xff, PC:0x0001, SR:SR(0xb1)),
                      [0x0000:0x0a])
        )
    }

    func test_adc_bcd_off_abs_y_overflow_set_no_carry_80_plus_ff() {
        do_the_test(
            TestState(CpuState(A:0x80, X:0x00, Y:0x00, SP:0xff, PC:0x0000, SR:SR(0x30)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff]),
            TestState(CpuState(A:0x7f, X:0x00, Y:0x00, SP:0xff, PC:0x0003, SR:SR(0x71)),
                      [0x0000:0x79, 0x0001:0x00, 0x0002:0xc0, 0xc000:0xff])
        )
    }
}
